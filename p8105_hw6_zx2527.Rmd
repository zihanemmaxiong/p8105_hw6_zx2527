---
title: "p8105_hw6_zx2527"
author: "Zihan Xiong"
date: "2025-12-03"
output: github_document
---

```{r, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(dplyr)
library(broom)
library(purrr)
library(knitr)
library(modelr)


knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

## Import data
```{r}
homi_raw=read.csv("./data/homicide-data.csv",na=c("NA", "0", "")) |>
  janitor::clean_names() 
```

```{r}
homi_clean<- homi_raw |>
  mutate(
    city_state=paste(city,state,sep=", "),
    solved=if_else(disposition=="Closed by arrest", 1, 0)
  ) |>
  filter(
    !(city_state=="Dallas, TX"),
    !(city_state=="Phoenix, AZ"),
    !(city_state=="Kansas City, MO"),
    !(city_state=="Tulsa, AL")
  ) |>
  filter(
    victim_race %in% c("White","Black")
  ) |>
  mutate(
    victim_age=as.numeric(victim_age)
  )

```

## Baltimore
```{r}
balt <- homi_clean |>
  filter(city_state=="Baltimore, MD")

fit_balt <- glm(
  solved~victim_age+victim_sex+victim_race,
  data = balt,
  family = binomial
)

res_balt <- tidy(fit_balt, exponentiate = TRUE, conf.int = TRUE) |>
  filter(term == "victim_sexMale")

knitr::kable(res_balt)

```

Estimate adjusted odds ratio: 0.44
Confidence interval: (0.34, 0.58)

## Other cities building function, then loop iteration
```{r}
glm_solved=function(df){
  glm(solved~victim_age + victim_sex + victim_race,
      data = df, family = binomial)
}
```

```{r}
city_glm_results=
  homi_clean |>
  group_by(city_state) |>
  nest() |>
  mutate(
    fits=map(data, glm_solved),
    results=map(fits, ~tidy(.x, exponentiate= TRUE, conf.int = TRUE))
  ) |>
  select(city_state, results) |>
  unnest(results) |>
  filter(term=="victim_sexMale") |>
  arrange(estimate)
```
## Make plot
```{r}
ggplot(city_glm_results,
       aes(x=reorder(city_state, estimate),
           y=estimate))+
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width=0.15)+
  geom_hline(yintercept = 1, linetype=2)+
  coord_flip()+
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Estimated Adjusted Odds Ratios for Solving Homicides by Victim Sex"
  )+
  theme_minimal(base_size = 11) +
  theme(
    axis.text.y = element_text(size = 6),  
    panel.grid.major.y = element_blank()   
  )
```

Most cities show lower odds of solving homicides involving male victims compared to female victims (OR < 1), even after adjusting for age and race. However, the strength of this disparity varies by city, with some locations showing much wider confidence intervals due to smaller sample sizes.

## Problem 2
```{r}
library(p8105.datasets)
data("weather_df")

weather_clean =
  weather_df |>
  drop_na(tmax, tmin, prcp)
```
look at the data first
```{r}
weather_clean |>
  lm(tmax~tmin+prcp, data=_) |>
  broom::glance() |>
  knitr::kable(digits = 3)
```

write a function
```{r}
weather_stats=function(df){
  fit=lm(tmax~tmin+prcp, data=df)
  
  g=broom::glance(fit)
  coef_df=broom::tidy(fit)
  
  r2=g$r.squared
  
  b1 = coef_df |> 
    filter(term == "tmin") |> 
    pull(estimate)
  
  b2 = coef_df |> 
    filter(term == "prcp") |> 
    pull(estimate)
  
  tibble(
    r2   = r2,
    b1b2 = b1 * b2
  )
}

```

check
```{r}
weather_stats(weather_df)
```
### Use 5000 samples bootstrap
```{r}
set.seed(1)

weather_bootstrap=
  weather_clean |>
  bootstrap(n=5000) |>
  mutate(
    df = map(strap, as_tibble),
    results = map(df, weather_stats)
  ) |>
  select(.id, results) |>
  unnest(results)
```
### make plot
```{r}
weather_bootstrap_long = 
  weather_bootstrap |> 
  pivot_longer(
    cols = c(r2, b1b2),
    names_to = "stat",
    values_to = "value"
  )
```

```{r}
weather_bootstrap_long |> 
  ggplot(aes(x = value)) + 
  geom_density() + 
  facet_wrap(~ stat, scales = "free") +
  labs(
    x = "Bootstrap estimate",
    y = "Density",
    title = "Bootstrap distributions of R^2 and beta1*beta2"
  )

```

### Calculate 95%CI
```{r}
weather_bootstrap_long |> 
  group_by(stat) |> 
  summarize(
    ci_lower = quantile(value, 0.025),
    ci_upper = quantile(value, 0.975)
  ) |> 
  knitr::kable(digits = 4)

```

